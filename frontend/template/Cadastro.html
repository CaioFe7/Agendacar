<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro - Agendacar</title>
    <link href="../static/Cadastro.css" rel="stylesheet" />
  </head>

  <body>
    <main class="wrap">
      <section class="left">
        <div class="bridge-ball"></div>
        <div class="pings" aria-hidden="true"><span></span><span></span></div>

        <div class="left-inner">
          <div class="header">
            <h1 class="title">Cadastro</h1>
          </div>

          <form class="form" id="form" novalidate>
            <div class="grid-2">
              <input type="text" id="nome" placeholder="Nome:" required />
              <input type="email" id="email" placeholder="Email:" required />
            </div>

            <div class="grid-2">
              <div class="password-wrapper">
                <input
                  type="password"
                  id="senha"
                  placeholder="Senha:"
                  minlength="8"
                  required
                />
                <span class="toggle" onclick="togglePassword('senha', this)">
                  <svg
                    class="eye open"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    width="20"
                    height="20"
                  >
                    <path
                      fill="currentColor"
                      d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 110-10 5 5 0 010 10zm0-8a3 3 0 100 6 3 3 0 000-6z"
                    />
                  </svg>
                  <svg
                    class="eye closed"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    width="20"
                    height="20"
                  >
                    <path
                      fill="currentColor"
                      d="M12 5c-2.19 0-4.19.5-6 1.35L4.35 4.7 3 6.05l3.1 3.1C4.27 10.34 3 12 3 12s4 7 9 7c1.86 0 3.57-.56 5.05-1.49L18.95 20l1.41-1.41L5.41 3.64 4 5.05 6.2 7.25C8.07 6.47 10.01 6 12 6c7 0 11 7 11 7s-1.14 1.88-3.05 3.49L19.66 14C21.09 12.85 22 11.5 22 11.5S18 5 12 5z"
                    />
                  </svg>
                </span>
              </div>

              <div class="password-wrapper">
                <input
                  type="password"
                  id="confirmar"
                  placeholder="Confirmar senha:"
                  minlength="8"
                  required
                />
                <span
                  class="toggle"
                  onclick="togglePassword('confirmar', this)"
                >
                  <svg
                    class="eye open"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    width="20"
                    height="20"
                  >
                    <path
                      fill="currentColor"
                      d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 110-10 5 5 0 010 10zm0-8a3 3 0 100 6 3 3 0 000-6z"
                    />
                  </svg>
                  <svg
                    class="eye closed"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    width="20"
                    height="20"
                  >
                    <path
                      fill="currentColor"
                      d="M12 5c-2.19 0-4.19.5-6 1.35L4.35 4.7 3 6.05l3.1 3.1C4.27 10.34 3 12 3 12s4 7 9 7c1.86 0 3.57-.56 5.05-1.49L18.95 20l1.41-1.41L5.41 3.64 4 5.05 6.2 7.25C8.07 6.47 10.01 6 12 6c7 0 11 7 11 7s-1.14 1.88-3.05 3.49L19.66 14C21.09 12.85 22 11.5 22 11.5S18 5 12 5z"
                    />
                  </svg>
                </span>
              </div>
            </div>

            <div class="btn-row">
              <button class="btn" type="submit">Criar Conta</button>
            </div>

            <p id="msg" class="msg" aria-live="polite"></p>
          </form>

          <div class="corner-bubble" aria-hidden="true"></div>
        </div>
      </section>

      <section class="right">
        <img src="../img/Imagempj.png" alt="Imagem lateral" class="hero-img" />
      </section>
    </main>

    <script>
      function togglePassword(id, el) {
        const input = document.getElementById(id);
        if (!input || !el) return;
        const open = el.querySelector(".eye.open");
        const closed = el.querySelector(".eye.closed");
        const isPassword = input.type === "password";
        input.type = isPassword ? "text" : "password";
        if (open && closed) {
          open.style.display = isPassword ? "none" : "inline";
          closed.style.display = isPassword ? "inline" : "none";
        }
      }

      function emailValido(email) {
        const regexBasico = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!regexBasico.test(email)) return false;
        const dominiosPermitidos = [
          "gmail.com",
          "hotmail.com",
          "outlook.com",
          "yahoo.com",
          "live.com",
          "icloud.com",
        ];
        const dominio = email.split("@")[1]?.toLowerCase();
        return dominiosPermitidos.includes(dominio);
      }

      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("form");
        const inputNome = document.getElementById("nome");
        const inputEmail = document.getElementById("email");
        const inputSenha = document.getElementById("senha");
        const inputConfirmar = document.getElementById("confirmar");
        const msg = document.getElementById("msg");
        const botao = document.querySelector(".btn");

        if (!form || !botao) return;

        function resetBotao() {
          botao.disabled = false;
          botao.classList.remove("loading", "success");
          botao.style.cursor = "pointer";
          botao.textContent = "Criar Conta";
        }

        form.addEventListener("submit", async (event) => {
          event.preventDefault(); // Impede recarregar a tela

          const nome = inputNome.value.trim();
          const email = inputEmail.value.trim();
          const senha = inputSenha.value;
          const confirmar = inputConfirmar.value;

          if (msg) {
            msg.textContent = "";
            msg.style.opacity = "0";
          }

          botao.disabled = true;
          botao.classList.add("loading");
          botao.textContent = "Processando...";

          // VALIDAÇÕES
          if (!nome || !email || !senha || !confirmar) {
            if (msg) {
              msg.textContent = "Preencha todos os campos.";
              msg.style.color = "#dc3545";
              msg.style.opacity = "1";
            }
            resetBotao();
            return;
          }
          if (!emailValido(email)) {
            if (msg) {
              msg.textContent = "Email inválido.";
              msg.style.color = "#dc3545";
              msg.style.opacity = "1";
            }
            resetBotao();
            return;
          }
          if (senha.length < 8) {
            if (msg) {
              msg.textContent = "Senha deve ter 8+ caracteres.";
              msg.style.color = "#dc3545";
              msg.style.opacity = "1";
            }
            resetBotao();
            return;
          }
          if (senha !== confirmar) {
            if (msg) {
              msg.textContent = "Senhas não conferem.";
              msg.style.color = "#dc3545";
              msg.style.opacity = "1";
            }
            resetBotao();
            return;
          }

          try {
            // 1. CONECTA NO FLASK (Porta 5000)
            const resp = await fetch("http://127.0.0.1:5000/cadastrar", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ nome, email, senha }),
            });

            let data = {};
            try {
              data = await resp.json();
            } catch (e) {}

            if (!resp.ok || data.status === "erro") {
              const erroMsg = data.msg || "Erro ao cadastrar.";
              if (msg) {
                msg.textContent = erroMsg;
                msg.style.color = "#dc3545";
                msg.style.opacity = "1";
              }
              resetBotao();
              return;
            }

            // SUCESSO
            if (msg) {
              msg.textContent = "Cadastrado com sucesso!";
              msg.style.color = "green";
              msg.style.opacity = "1";
            }
            botao.classList.remove("loading");
            botao.classList.add("success");
            botao.textContent = "✔";

            setTimeout(() => {
              // 2. VOLTA PRO ARQUIVO NO LIVE SERVER
              window.location.href = "Login.html";
            }, 1000);
          } catch (erro) {
            console.error(erro);
            if (msg) {
              msg.textContent = "Erro de conexão com o Python.";
              msg.style.color = "#dc3545";
              msg.style.opacity = "1";
            }
            resetBotao();
          }
        });
      });
    </script>
  </body>
</html>
